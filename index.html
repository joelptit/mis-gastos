<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="loginScreen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-black text-center mb-6">ACCESO</h2>
            <input type="email" id="userEmail" class="w-full border p-4 rounded-xl mb-4" placeholder="Email">
            <input type="password" id="userPass" class="w-full border p-4 rounded-xl mb-4" placeholder="Clave">
            <button onclick="validarAcceso()" id="btnLogin" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">ENTRAR</button>
            <p id="errorMsg" class="text-red-500 mt-4 hidden text-center font-bold italic">Datos incorrectos</p>
        </div>
    </div>

    <div id="mainContent" class="hidden max-w-lg mx-auto bg-white min-h-screen shadow-lg">
        <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
            <span class="font-bold uppercase">Nuevo Registro</span>
            <button onclick="cerrarSesion()" class="text-xs bg-blue-800 px-2 py-1 rounded">Salir</button>
        </header>

        <form id="formGasto" class="p-4 space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Fecha</label>
                <input type="datetime-local" id="fecha" required class="w-full p-3 border rounded-xl">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Usuario</label>
                    <input type="text" id="usuarioDisplay" readonly class="w-full p-3 border rounded-xl bg-gray-50">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Tipo</label>
                    <select id="categoria" class="w-full p-3 border rounded-xl">
                        <option>Alimentos</option><option>Servicios</option><option>Transporte</option><option>Otros</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-blue-600 uppercase">USD ($)</label>
                    <input type="number" id="usd" step="0.01" readonly class="w-full p-3 border-2 rounded-xl bg-gray-50 font-bold">
                </div>
                <div>
                    <label class="text-xs font-bold text-green-600 uppercase">VES (Bs)</label>
                    <input type="number" id="ves" step="0.01" oninput="calcularUsd()" class="w-full p-3 border border-blue-500 rounded-xl font-bold">
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">ObservaciÃ³n</label>
                <input type="text" id="observacion" class="w-full p-3 border rounded-xl" placeholder="Gasto de...">
            </div>

            <div class="border-2 border-dashed p-4 rounded-xl text-center bg-gray-50">
                <label class="cursor-pointer">
                    <span class="text-sm font-bold text-blue-600">ðŸ“· Seleccionar comprobante</span>
                    <input type="file" id="archivo" accept="image/*" class="hidden" onchange="procesarImagen(this)">
                </label>
                <img id="preview" class="hidden mt-2 max-h-32 mx-auto rounded shadow">
            </div>

            <button type="submit" id="btnGuardar" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest">Guardar Gasto</button>
        </form>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUBtnUly2TxPQDYFJ7sApZWlklYkN3E6cGvxWlZs0OgnUb3km0wTmBtPdZwqE1zL-SwQ/exec";
        let tasaActual = 0;
        let imgB64 = null;
        let imgMime = "";

        window.onload = async () => {
            const sesion = localStorage.getItem('session');
            if(sesion) mostrarApp(JSON.parse(sesion).nombre);
            
            // Poner fecha/hora actual
            const ahora = new Date();
            ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
            document.getElementById('fecha').value = ahora.toISOString().slice(0, 16);

            // Obtener tasa
            const res = await fetch(`${WEB_APP_URL}?action=getTasa`);
            const data = await res.json();
            tasaActual = data.tasa;
        };

        function calcularUsd() {
            const valorVes = document.getElementById('ves').value;
            const campoUsd = document.getElementById('usd');
            
            if (valorVes && tasaActual > 0) {
                const resultado = parseFloat(valorVes) / tasaActual;
                campoUsd.value = resultado.toFixed(2);
            } else {
                campoUsd.value = "";
            }            
        }

        function procesarImagen(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgB64 = e.target.result;
                    imgMime = input.files[0].type;
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('preview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function validarAcceso() {
            const email = document.getElementById('userEmail').value;
            const clave = document.getElementById('userPass').value;
            const btnLogin = document.getElementById('btnLogin');
            btnLogin.disabled = true; 
            btnLogin.innerText = "ENTRANDO...";
            const res = await fetch(`${WEB_APP_URL}?action=validarUsuario&email=${email}&clave=${clave}`);
            const data = await res.json();
            if(data.status === 'success') {
                localStorage.setItem('session', JSON.stringify(data));
                mostrarApp(data.nombre);
            } else { 
                btnLogin.disabled = false; 
                btnLogin.innerText = "ENTRAR";
                document.getElementById('errorMsg').classList.remove('hidden'); }
        }

        function mostrarApp(nombre) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('usuarioDisplay').value = nombre;
        }

        function cerrarSesion() { localStorage.removeItem('session'); location.reload(); }

        document.getElementById('formGasto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnGuardar');
    btn.disabled = true; 
    btn.innerText = "REGISTRANDO...";

    const payload = {
        fecha: document.getElementById('fecha').value,
        usuario: document.getElementById('usuarioDisplay').value,
        usd: document.getElementById('usd').value,
        ves: document.getElementById('ves').value,
        categoria: document.getElementById('categoria').value,
        observacion: document.getElementById('observacion').value,
        archivoB64: imgB64, // Variable global donde guardamos el base64
        mimeType: imgMime
    };

    try {
        console.log(payload);
        // Enviamos como texto plano para evitar problemas de CORS con Google Scripts
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        // Como no podemos leer la respuesta directamente debido a redirecciones de Google
        // asumimos Ã©xito si no hay error de red. 
        alert("Â¡Registro enviado con Ã©xito!");
        //location.reload();

    } catch(err) {
        console.error(err);
        alert("Error al enviar: " + err.message);
        btn.disabled = false; 
        btn.innerText = "Guardar Gasto";
    }
});
    </script>
</body>
</html>
