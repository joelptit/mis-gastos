<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastos Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { color: #2563eb; } /* Azul 600 */
        body { padding-bottom: 70px; } /* Espacio para el Navbar */
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="loginScreen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-black text-center mb-6">ACCESO</h2>
            <input type="email" id="userEmail" class="w-full border p-4 rounded-xl mb-4" placeholder="Email">
            <input type="password" id="userPass" class="w-full border p-4 rounded-xl mb-4" placeholder="Clave">
            <button onclick="validarAcceso()" id="btnLogin" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">ENTRAR</button>
            <p id="errorMsg" class="text-red-500 mt-4 hidden text-center font-bold italic">Datos incorrectos</p>
        </div>
    </div>

    <div id="mainContent" class="hidden max-w-lg mx-auto bg-white min-h-screen shadow-lg relative">
        
        <section id="section-home" class="app-section">
            <header class="bg-blue-600 text-white p-4 sticky top-0 z-10">
                <span class="font-bold uppercase">Nuevo Registro</span>
            </header>
            <form id="formGasto" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Fecha</label>
                    <input type="datetime-local" id="fecha" required class="w-full p-3 border rounded-xl">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Usuario</label>
                        <input type="text" id="usuarioDisplay" readonly class="w-full p-3 border rounded-xl bg-gray-50">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Tipo</label>
                        <select id="categoria" class="w-full p-3 border rounded-xl">
                            <option>Alimentos</option><option>Servicios</option><option>Transporte</option><option>Otros</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-blue-600 uppercase">USD ($)</label>
                        <input type="number" id="usd" step="0.01" readonly class="w-full p-3 border-2 rounded-xl bg-gray-50 font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-green-600 uppercase">VES (Bs)</label>
                        <input type="number" id="ves" step="0.01" oninput="calcularUsd()" class="w-full p-3 border border-blue-500 rounded-xl font-bold">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Observaci贸n</label>
                    <input type="text" id="observacion" class="w-full p-3 border rounded-xl" placeholder="Gasto de...">
                </div>
                <div class="border-2 border-dashed p-4 rounded-xl text-center bg-gray-50">
                    <label class="cursor-pointer">
                        <span class="text-sm font-bold text-blue-600"> Seleccionar comprobante</span>
                        <input type="file" id="archivo" accept="image/*" class="hidden" onchange="procesarImagen(this)">
                    </label>
                    <img id="preview" class="hidden mt-2 max-h-32 mx-auto rounded shadow">
                </div>
                <button type="submit" id="btnGuardar" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest">Guardar Gasto</button>
            </form>
        </section>

        <section id="section-history" class="app-section hidden">
            <header class="bg-slate-800 text-white p-4 sticky top-0 z-10">
                <span class="font-bold uppercase">Hist贸rico de Gastos</span>
            </header>
            <div class="p-4" id="historyList">
                <p class="text-center text-gray-500 py-10">Cargando movimientos...</p>
            </div>
        </section>

        <section id="section-charts" class="app-section hidden">
            <header class="bg-indigo-600 text-white p-4 sticky top-0 z-10">
                <span class="font-bold uppercase">Indicadores</span>
            </header>
            <div class="p-10 text-center">
                <div class="text-5xl mb-4"></div>
                <p class="text-gray-500">Pr贸ximamente: Gr谩ficas de consumo mensual.</p>
            </div>
        </section>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-2 z-50 max-w-lg mx-auto">
            <button onclick="switchTab('home')" class="flex flex-col items-center gap-1 text-gray-400 active-tab" id="nav-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-[10px] font-bold uppercase">Home</span>
            </button>
            <button onclick="switchTab('history')" class="flex flex-col items-center gap-1 text-gray-400" id="nav-history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-[10px] font-bold uppercase">Hist贸rico</span>
            </button>
            <button onclick="switchTab('charts')" class="flex flex-col items-center gap-1 text-gray-400" id="nav-charts">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="text-[10px] font-bold uppercase">Gr谩ficas</span>
            </button>
            <button onclick="cerrarSesion()" class="flex flex-col items-center gap-1 text-red-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="text-[10px] font-bold uppercase">Salir</span>
            </button>
        </nav>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUBtnUly2TxPQDYFJ7sApZWlklYkN3E6cGvxWlZs0OgnUb3km0wTmBtPdZwqE1zL-SwQ/exec";
        let tasaActual = 0;
        let imgB64 = null;
        let imgMime = "";

        // NAVEGACIN ENTRE TABS
        function switchTab(tabName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.app-section').forEach(sec => sec.classList.add('hidden'));
            // Quitar color activo de todos los botones
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            
            // Mostrar secci贸n seleccionada
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            // Colorear bot贸n seleccionado
            document.getElementById(`nav-${tabName}`).classList.add('active-tab');

            if(tabName === 'history') cargarHistorial();
        }

        window.onload = async () => {
            const sesion = localStorage.getItem('session');
            if(sesion) mostrarApp(JSON.parse(sesion).nombre);
            
            const ahora = new Date();
            ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
            document.getElementById('fecha').value = ahora.toISOString().slice(0, 16);

            const res = await fetch(`${WEB_APP_URL}?action=getTasa`);
            const data = await res.json();
            tasaActual = data.tasa;
        };

        function calcularUsd() {
            const valorVes = document.getElementById('ves').value;
            const campoUsd = document.getElementById('usd');
            if (valorVes && tasaActual > 0) {
                const resultado = parseFloat(valorVes) / tasaActual;
                campoUsd.value = resultado.toFixed(2);
            } else { campoUsd.value = ""; }
        }

        function procesarImagen(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgB64 = e.target.result;
                    imgMime = input.files[0].type;
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('preview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function validarAcceso() {
            const email = document.getElementById('userEmail').value;
            const clave = document.getElementById('userPass').value;
            const btnLogin = document.getElementById('btnLogin');
            btnLogin.disabled = true; btnLogin.innerText = "ENTRANDO...";
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=validarUsuario&email=${email}&clave=${clave}`);
                const data = await res.json();
                if(data.status === 'success') {
                    localStorage.setItem('session', JSON.stringify(data));
                    mostrarApp(data.nombre);
                } else { 
                    btnLogin.disabled = false; btnLogin.innerText = "ENTRAR";
                    document.getElementById('errorMsg').classList.remove('hidden'); 
                }
            } catch(e) { alert("Error de red"); btnLogin.disabled = false; }
        }

        function mostrarApp(nombre) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('usuarioDisplay').value = nombre;
        }

        function cerrarSesion() { localStorage.removeItem('session'); location.reload(); }

        async function cargarHistorial() {
            const container = document.getElementById('historyList');
            container.innerHTML = '<p class="text-center text-gray-400 py-10 italic">Consultando base de datos...</p>';
            try {
                const res = await fetch(WEB_APP_URL);
                const data = await res.json();
                container.innerHTML = "";
                // Listamos los 煤ltimos 20 de forma inversa
                data.reverse().slice(0,20).forEach(g => {
                    const card = `
                        <div class="bg-slate-50 border-b p-3 flex justify-between items-center mb-1">
                            <div>
                                <p class="text-[10px] text-gray-400 font-bold uppercase">${g[1]}</p> <p class="font-bold text-gray-700">${g[7] || 'Sin obs.'}</p> <span class="text-[9px] bg-slate-200 px-2 py-0.5 rounded text-gray-600 font-bold">${g[6]}</span> </div>
                            <div class="text-right">
                                <p class="text-blue-600 font-black">$${g[3]}</p>
                                <p class="text-[10px] text-gray-400">Bs. ${g[4]}</p>
                            </div>
                        </div>`;
                    container.innerHTML += card;
                });
            } catch(e) { container.innerHTML = "Error al cargar datos."; }
        }

        document.getElementById('formGasto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnGuardar');
            btn.disabled = true; btn.innerText = "REGISTRANDO...";
            const payload = {
                fecha: document.getElementById('fecha').value,
                usuario: document.getElementById('usuarioDisplay').value,
                usd: document.getElementById('usd').value,
                ves: document.getElementById('ves').value,
                categoria: document.getElementById('categoria').value,
                observacion: document.getElementById('observacion').value,
                archivoB64: imgB64,
                mimeType: imgMime
            };
            try {
                await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("隆Registro enviado con 茅xito!");
                location.reload();
            } catch(err) {
                alert("Error al enviar");
                btn.disabled = false; btn.innerText = "Guardar Gasto";
            }
        });
    </script>
</body>
</html>
