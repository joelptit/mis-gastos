<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastos Pro — v1.11</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: { DEFAULT: 'hsl(var(--primary))', foreground: 'hsl(var(--primary-foreground))' },
                        secondary: { DEFAULT: 'hsl(var(--secondary))', foreground: 'hsl(var(--secondary-foreground))' },
                        muted: { DEFAULT: 'hsl(var(--muted))', foreground: 'hsl(var(--muted-foreground))' },
                        card: { DEFAULT: 'hsl(var(--card))', foreground: 'hsl(var(--card-foreground))' },
                        destructive: 'hsl(var(--destructive))',
                    },
                    borderRadius: { lg: 'var(--radius)', md: 'calc(var(--radius) - 2px)', sm: 'calc(var(--radius) - 4px)' }
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --destructive: 0 84.2% 60.2%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 5.9% 10%;
            --radius: 0.5rem;
        }
        body { font-family: 'Inter', system-ui, sans-serif; padding-bottom: 80px; background: hsl(var(--background)); color: hsl(var(--foreground)); }
        .btn-primary { background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); border: 1px solid hsl(var(--border)); }
        .btn-secondary:hover { background: hsl(240 4.8% 92%); }
        .input-base { border: 1px solid hsl(var(--input)); border-radius: var(--radius); background: hsl(var(--background)); }
        .input-base:focus { outline: none; box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2); border-color: hsl(var(--ring)); }
        #loader { display: none; position: fixed; inset: 0; background: hsl(var(--background) / 0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #loader.active { display: flex !important; }
        .nav-btn { color: hsl(var(--muted-foreground)); transition: color 0.15s; }
        .nav-btn.active { color: hsl(var(--primary)); font-weight: 600; }
        .card { background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); }
        .toast { transform: translateY(-100%); opacity: 0; transition: transform 0.25s, opacity 0.25s; }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-10 w-10 border-2 border-primary border-t-transparent"></div>
        <p id="loaderText" class="text-sm text-muted-foreground mt-3">Procesando...</p>
    </div>

    <!-- Toast para mensajes (reemplazo de alert) -->
    <div id="toast" class="toast fixed top-4 left-4 right-4 z-[100] max-w-lg mx-auto">
        <div id="toastContent" class="card px-4 py-3 shadow-lg flex items-center gap-3"></div>
    </div>

    <!-- Login -->
    <div id="loginScreen" class="fixed inset-0 bg-zinc-950/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm p-6 sm:p-8 shadow-xl">
            <div class="text-center mb-6">
                <h1 class="text-xl font-semibold tracking-tight text-card-foreground">Gastos Pro</h1>
                <p class="text-sm text-muted-foreground mt-1">Inicia sesión para continuar</p>
            </div>
            <form onsubmit="validarAcceso(); return false;" class="space-y-4">
                <div class="space-y-2">
                    <label for="userEmail" class="text-sm font-medium text-card-foreground">Correo</label>
                    <input type="email" id="userEmail" class="input-base w-full h-10 px-3 text-sm" placeholder="tu@email.com" required>
                </div>
                <div class="space-y-2">
                    <label for="userPass" class="text-sm font-medium text-card-foreground">Contraseña</label>
                    <input type="password" id="userPass" class="input-base w-full h-10 px-3 text-sm" placeholder="••••••••" required>
                </div>
                <button type="submit" id="btnLogin" class="btn-primary w-full h-10 rounded-md text-sm font-medium transition-opacity">
                    Entrar
                </button>
            </form>
            <p id="errorMsg" class="text-sm text-destructive mt-4 hidden text-center">Correo o contraseña incorrectos.</p>
        </div>
    </div>

    <!-- App principal -->
    <div id="mainContent" class="hidden max-w-lg mx-auto min-h-screen relative">
        <section id="section-home" class="app-section">
            <header class="sticky top-0 z-10 bg-card border-b border-border px-4 py-3 flex justify-between items-center">
                <h2 class="text-base font-semibold text-card-foreground">Nuevo gasto</h2>
                <span id="tasaBadge" class="text-xs text-muted-foreground bg-muted px-2.5 py-1 rounded-md font-medium">Cargando tasa...</span>
            </header>

            <form id="formGasto" class="p-4 space-y-5">
                <div class="space-y-2">
                    <label for="fecha" class="text-sm font-medium text-card-foreground">Fecha</label>
                    <input type="datetime-local" id="fecha" required class="input-base w-full h-10 px-3 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="usuarioDisplay" class="text-sm font-medium text-card-foreground">Usuario</label>
                        <input type="text" id="usuarioDisplay" readonly class="input-base w-full h-10 px-3 text-sm bg-muted text-muted-foreground cursor-not-allowed">
                    </div>
                    <div class="space-y-2">
                        <label for="categoria" class="text-sm font-medium text-card-foreground">Categoría</label>
                        <select id="categoria" class="input-base w-full h-10 px-3 text-sm bg-card">
                            <option>Alimentos</option>
                            <option>Servicios</option>
                            <option>Transporte</option>
                            <option>Varios</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="ves" class="text-sm font-medium text-card-foreground">Monto (VES)</label>
                        <input type="number" id="ves" step="0.01" oninput="calcularUsd()" class="input-base w-full h-10 px-3 text-sm" placeholder="0.00">
                    </div>
                    <div class="space-y-2">
                        <label for="usd" class="text-sm font-medium text-card-foreground">Monto (USD)</label>
                        <input type="number" id="usd" step="0.01" readonly class="input-base w-full h-10 px-3 text-sm bg-muted text-muted-foreground">
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="observacion" class="text-sm font-medium text-card-foreground">Observación</label>
                    <input type="text" id="observacion" class="input-base w-full h-10 px-3 text-sm" placeholder="¿En qué se gastó?">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium text-card-foreground">Foto de factura (opcional)</label>
                    <label class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-input rounded-md cursor-pointer hover:bg-muted/50 transition-colors">
                        <input type="file" id="archivo" accept="image/*" class="hidden" onchange="procesarImagen(this)">
                        <span class="text-sm text-muted-foreground flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span id="fileName">Arrastra una imagen o haz clic</span>
                        </span>
                        <img id="preview" class="hidden mt-2 max-h-24 rounded object-cover border border-border">
                    </label>
                </div>

                <button type="submit" id="btnGuardar" class="btn-primary w-full h-11 rounded-md text-sm font-medium">
                    Guardar registro
                </button>
            </form>
        </section>

        <section id="section-history" class="app-section hidden pb-24">
            <header class="sticky top-0 z-10 bg-card border-b border-border px-4 py-3">
                <h2 class="text-base font-semibold text-card-foreground">Historial de gastos</h2>
            </header>
            <div id="historyList" class="p-4 space-y-3"></div>
        </section>

        <nav class="fixed bottom-0 left-0 right-0 bg-card border-t border-border flex justify-around py-3 z-50 max-w-lg mx-auto">
            <button type="button" onclick="switchTab('home')" id="nav-home" class="nav-btn active flex flex-col items-center gap-1 px-4 py-1 rounded-md hover:bg-muted/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                <span class="text-xs font-medium">Nuevo</span>
            </button>
            <button type="button" onclick="switchTab('history')" id="nav-history" class="nav-btn flex flex-col items-center gap-1 px-4 py-1 rounded-md hover:bg-muted/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs font-medium">Historial</span>
            </button>
            <button type="button" onclick="cerrarSesion()" class="nav-btn flex flex-col items-center gap-1 px-4 py-1 text-destructive hover:bg-destructive/10 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H4a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                <span class="text-xs font-medium">Salir</span>
            </button>
        </nav>
    </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz0uszzl0MawDgb0RuzD1bfyxiB137Agedy_2iWBzsgC1ZH0EFfbTrXUlPU3vRSAn6o8Q/exec";
let tasaActual = 40;
let imgB64 = null;

function showToast(message, type) {
    const toast = document.getElementById('toast');
    const content = document.getElementById('toastContent');
    content.innerHTML = type === 'success'
        ? `<span class="text-green-600">✓</span><span class="text-sm text-card-foreground">${message}</span>`
        : `<span class="text-destructive">✕</span><span class="text-sm text-card-foreground">${message}</span>`;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
}

window.onload = () => {
    const sesion = localStorage.getItem('session');
    if (sesion) mostrarApp(JSON.parse(sesion).nombre);
    const ahora = new Date();
    ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
    document.getElementById('fecha').value = ahora.toISOString().slice(0, 16);
    obtenerTasa();
};

async function obtenerTasa() {
    try {
        const res = await fetch(`${WEB_APP_URL}?action=getTasa`);
        const data = await res.json();
        tasaActual = data.tasa;
        document.getElementById('tasaBadge').innerText = "Tasa: " + tasaActual + " Bs";
    } catch (e) {
        document.getElementById('tasaBadge').innerText = "Tasa: " + tasaActual + " Bs";
    }
}

function calcularUsd() {
    const ves = document.getElementById('ves').value;
    document.getElementById('usd').value = (ves && tasaActual > 0) ? (ves / tasaActual).toFixed(2) : "";
}

function procesarImagen(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 800;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h *= MAX / w; w = MAX; } else if (h > MAX) { w *= MAX / h; h = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                imgB64 = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('preview').src = imgB64;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('fileName').innerText = "Imagen lista";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

async function validarAcceso() {
    const email = document.getElementById('userEmail').value.trim();
    const clave = document.getElementById('userPass').value;
    if (!email || !clave) {
        showToast("Completa correo y contraseña.", "error");
        return;
    }
    document.getElementById('loader').classList.add('active');
    document.getElementById('errorMsg').classList.add('hidden');
    try {
        const res = await fetch(`${WEB_APP_URL}?action=validarUsuario&email=${encodeURIComponent(email)}&clave=${encodeURIComponent(clave)}`);
        const data = await res.json();
        if (data.status === 'success') {
            localStorage.setItem('session', JSON.stringify(data));
            mostrarApp(data.nombre);
        } else {
            document.getElementById('errorMsg').classList.remove('hidden');
        }
    } catch (e) {
        showToast("Error de red. Revisa tu conexión.", "error");
    }
    document.getElementById('loader').classList.remove('active');
}

function mostrarApp(nombre) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('usuarioDisplay').value = nombre;
}

document.getElementById('formGasto').onsubmit = async (e) => {
    e.preventDefault();
    const loader = document.getElementById('loader');
    loader.classList.add('active');

    const payload = {
        fecha: document.getElementById('fecha').value,
        usuario: document.getElementById('usuarioDisplay').value,
        usd: document.getElementById('usd').value,
        ves: document.getElementById('ves').value,
        categoria: document.getElementById('categoria').value,
        observacion: document.getElementById('observacion').value,
        archivoB64: imgB64
    };

    try {
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await res.json();

        if (data.status === "success") {
            const msg = data.imageWarning
                ? "Registro guardado. La imagen no pudo subirse."
                : "Registro guardado correctamente.";
            showToast(msg, data.imageWarning ? "error" : "success");
            imgB64 = null;
            setTimeout(() => location.reload(), 1500);
        } else {
            throw new Error(data.message || "Error en el servidor");
        }
    } catch (err) {
        showToast(err.message || "Error al guardar", "error");
    } finally {
        loader.classList.remove('active');
    }
};

function switchTab(t) {
    document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
    document.getElementById('section-' + t).classList.remove('hidden');
    document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('active');
        b.classList.add('nav-btn');
    });
    const activeBtn = document.getElementById('nav-' + t);
    if (activeBtn) activeBtn.classList.add('active');
    if (t === 'history') cargarHistorial();
}

async function cargarHistorial() {
    const list = document.getElementById('historyList');
    list.innerHTML = '<p class="text-center text-sm text-muted-foreground py-8">Cargando...</p>';
    try {
        const res = await fetch(WEB_APP_URL);
        const data = await res.json();
        if (!data || !data.length) {
            list.innerHTML = '<p class="text-center text-sm text-muted-foreground py-8">No hay registros aún.</p>';
            return;
        }
        list.innerHTML = data.reverse().map(g => {
            const linkImg = g[5] && g[5].startsWith('http') ? g[5] : null;
            return `
                <div class="card p-4 flex items-center gap-4">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-card-foreground truncate">${(g[7] || 'Sin observación').replace(/</g, '&lt;')}</p>
                        <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                            <span class="text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded font-medium">${(g[6] || '').replace(/</g, '&lt;')}</span>
                            <span class="text-xs text-muted-foreground">${new Date(g[1]).toLocaleDateString('es')}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-right">
                            <p class="text-sm font-semibold text-card-foreground">$${parseFloat(g[3] || 0).toFixed(2)}</p>
                            <p class="text-xs text-muted-foreground">${parseFloat(g[4] || 0).toFixed(2)} Bs</p>
                        </div>
                        ${linkImg ? `
                            <a href="${linkImg}" target="_blank" rel="noopener" class="p-2 rounded-md border border-border text-muted-foreground hover:bg-muted hover:text-card-foreground transition-colors" title="Ver factura">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14" /></svg>
                            </a>
                        ` : `
                            <span class="p-2 rounded-md border border-border text-muted-foreground/50" title="Sin imagen"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14" /></svg></span>
                        `}
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        list.innerHTML = '<p class="text-center text-sm text-destructive py-8">Error al cargar el historial.</p>';
    }
}

function cerrarSesion() {
    localStorage.clear();
    location.reload();
}
</script>
</body>
</html>
