<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastos Pro — v1.13</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: { DEFAULT: 'hsl(var(--primary))', foreground: 'hsl(var(--primary-foreground))' },
                        secondary: { DEFAULT: 'hsl(var(--secondary))', foreground: 'hsl(var(--secondary-foreground))' },
                        muted: { DEFAULT: 'hsl(var(--muted))', foreground: 'hsl(var(--muted-foreground))' },
                        card: { DEFAULT: 'hsl(var(--card))', foreground: 'hsl(var(--card-foreground))' },
                        destructive: 'hsl(var(--destructive))',
                    },
                    borderRadius: { lg: 'var(--radius)', md: 'calc(var(--radius) - 2px)', sm: 'calc(var(--radius) - 4px)' }
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --destructive: 0 84.2% 60.2%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 5.9% 10%;
            --radius: 0.5rem;
        }
        .dark {
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 6%;
            --card-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 240 5.9% 10%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%;
            --destructive: 0 62.8% 50.6%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 240 4.9% 83.9%;
        }
        body { font-family: 'Inter', system-ui, sans-serif; padding-bottom: 80px; background: hsl(var(--background)); color: hsl(var(--foreground)); transition: background-color 0.2s, color 0.2s; }
        .btn-primary { background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); border: 1px solid hsl(var(--border)); }
        .btn-secondary:hover { background: hsl(240 4.8% 92%); }
        .input-base { border: 1px solid hsl(var(--input)); border-radius: var(--radius); background: hsl(var(--background)); }
        .input-base:focus { outline: none; box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2); border-color: hsl(var(--ring)); }
        #loader { display: none; position: fixed; inset: 0; background: hsl(var(--background) / 0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #loader.active { display: flex !important; }
        .nav-btn { color: hsl(var(--muted-foreground)); transition: color 0.15s; }
        .nav-btn.active { color: hsl(var(--primary)); font-weight: 600; }
        .card { background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); }
        .toast { transform: translateY(-100%); opacity: 0; transition: transform 0.25s, opacity 0.25s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .theme-toggle { appearance: none; background: transparent; border: none; cursor: pointer; padding: 0.5rem; border-radius: var(--radius); color: hsl(var(--muted-foreground)); }
        .theme-toggle:hover { color: hsl(var(--foreground)); background: hsl(var(--muted)); }
        .history-group-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem; }
        #loginScreen { background: rgba(0,0,0,0.85); }
        .dark #loginScreen { background: hsl(240 10% 3.9% / 0.98); }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-10 w-10 border-2 border-primary border-t-transparent"></div>
        <p id="loaderText" class="text-sm text-muted-foreground mt-3">Procesando...</p>
    </div>

    <!-- Toast para mensajes (reemplazo de alert) -->
    <div id="toast" class="toast fixed top-4 left-4 right-4 z-[100] max-w-lg mx-auto">
        <div id="toastContent" class="card px-4 py-3 shadow-lg flex items-center gap-3"></div>
    </div>

    <!-- Login -->
    <div id="loginScreen" class="fixed inset-0 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <button type="button" id="themeToggleLogin" class="theme-toggle fixed top-4 right-4 z-50" onclick="toggleTheme()" title="Cambiar tema" aria-label="Cambiar tema">
            <svg id="iconSun" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <svg id="iconMoon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
        </button>
        <div class="card w-full max-w-sm p-6 sm:p-8 shadow-xl">
            <div class="text-center mb-6">
                <h1 class="text-xl font-semibold tracking-tight text-card-foreground">Gastos Pro</h1>
                <p class="text-sm text-muted-foreground mt-1">Inicia sesión para continuar</p>
            </div>
            <form onsubmit="validarAcceso(); return false;" class="space-y-4">
                <div class="space-y-2">
                    <label for="userEmail" class="text-sm font-medium text-card-foreground">Correo</label>
                    <input type="email" id="userEmail" class="input-base w-full h-10 px-3 text-sm" placeholder="tu@email.com" required>
                </div>
                <div class="space-y-2">
                    <label for="userPass" class="text-sm font-medium text-card-foreground">Contraseña</label>
                    <input type="password" id="userPass" class="input-base w-full h-10 px-3 text-sm" placeholder="••••••••" required>
                </div>
                <button type="submit" id="btnLogin" class="btn-primary w-full h-10 rounded-md text-sm font-medium transition-opacity">
                    Entrar
                </button>
            </form>
            <p id="errorMsg" class="text-sm text-destructive mt-4 hidden text-center">Correo o contraseña incorrectos.</p>
        </div>
    </div>

    <!-- App principal -->
    <div id="mainContent" class="hidden max-w-lg mx-auto min-h-screen relative">
        <section id="section-home" class="app-section">
            <header class="sticky top-0 z-10 bg-card border-b border-border px-4 py-3 flex justify-between items-center">
                <h2 class="text-base font-semibold text-card-foreground">Nuevo gasto</h2>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="abrirModalTasa()" id="tasaBadge" class="text-xs text-muted-foreground bg-muted hover:bg-muted/80 px-2.5 py-1 rounded-md font-medium transition-colors" title="Ver o editar tasa">Cargando tasa...</button>
                    <button type="button" id="themeToggleHome" class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema" aria-label="Cambiar tema">
                        <svg id="iconSunHome" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="iconMoonHome" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                </div>
            </header>

            <!-- Modal Tasa -->
            <div id="modalTasa" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onclick="if(event.target===this) cerrarModalTasa()">
                <div class="card w-full max-w-sm p-4 shadow-xl" onclick="event.stopPropagation()">
                    <h3 class="text-base font-semibold text-card-foreground mb-3">Tasa del dólar (Bs)</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="inputTasa" step="0.01" min="0.01" class="input-base flex-1 h-10 px-3 text-sm" placeholder="Ej: 40">
                        <button type="button" onclick="guardarTasaManual()" class="btn-primary h-10 px-4 rounded-md text-sm font-medium">Guardar</button>
                    </div>
                    <button type="button" onclick="obtenerTasaBCV()" class="btn-secondary w-full h-10 rounded-md text-sm font-medium mb-2">
                        Obtener tasa oficial BCV
                    </button>
                    <p id="tasaBCVMsg" class="text-xs text-muted-foreground hidden"></p>
                    <button type="button" onclick="cerrarModalTasa()" class="w-full mt-2 text-sm text-muted-foreground hover:text-card-foreground">Cerrar</button>
                </div>
            </div>

            <!-- Modal Nueva Categoría -->
            <div id="modalNuevaCategoria" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onclick="if(event.target===this) cerrarModalNuevaCategoria()">
                <div class="card w-full max-w-sm p-4 shadow-xl" onclick="event.stopPropagation()">
                    <h3 class="text-base font-semibold text-card-foreground mb-3">Nueva categoría</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="inputNuevaCategoria" class="input-base flex-1 h-10 px-3 text-sm" placeholder="Nombre" maxlength="50">
                        <button type="button" onclick="agregarCategoria()" class="btn-primary h-10 px-4 rounded-md text-sm font-medium">Agregar</button>
                    </div>
                    <button type="button" onclick="cerrarModalNuevaCategoria()" class="w-full text-sm text-muted-foreground hover:text-card-foreground">Cerrar</button>
                </div>
            </div>

            <form id="formGasto" class="p-4 space-y-5">
                <div class="space-y-2">
                    <label for="fecha" class="text-sm font-medium text-card-foreground">Fecha</label>
                    <input type="datetime-local" id="fecha" required class="input-base w-full h-10 px-3 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="usuarioDisplay" class="text-sm font-medium text-card-foreground">Usuario</label>
                        <input type="text" id="usuarioDisplay" readonly class="input-base w-full h-10 px-3 text-sm bg-muted text-muted-foreground cursor-not-allowed">
                    </div>
                    <div class="space-y-2">
                        <label for="categoria" class="text-sm font-medium text-card-foreground">Categoría</label>
                        <div class="flex gap-2">
                            <select id="categoria" class="input-base flex-1 h-10 px-3 text-sm bg-card"></select>
                            <button type="button" onclick="abrirModalNuevaCategoria()" class="btn-secondary shrink-0 h-10 px-3 rounded-md text-sm font-medium" title="Agregar categoría">+</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="ves" class="text-sm font-medium text-card-foreground">Monto (VES)</label>
                        <input type="number" id="ves" step="0.01" oninput="calcularUsd()" class="input-base w-full h-10 px-3 text-sm" placeholder="0.00">
                    </div>
                    <div class="space-y-2">
                        <label for="usd" class="text-sm font-medium text-card-foreground">Monto (USD)</label>
                        <input type="number" id="usd" step="0.01" readonly class="input-base w-full h-10 px-3 text-sm bg-muted text-muted-foreground">
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="observacion" class="text-sm font-medium text-card-foreground">Observación</label>
                    <input type="text" id="observacion" class="input-base w-full h-10 px-3 text-sm" placeholder="¿En qué se gastó?">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium text-card-foreground">Foto de factura (opcional)</label>
                    <label class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-input rounded-md cursor-pointer hover:bg-muted/50 transition-colors">
                        <input type="file" id="archivo" accept="image/*" class="hidden" onchange="procesarImagen(this)">
                        <span class="text-sm text-muted-foreground flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span id="fileName">Arrastra una imagen o haz clic</span>
                        </span>
                        <img id="preview" class="hidden mt-2 max-h-24 rounded object-cover border border-border">
                    </label>
                </div>

                <button type="submit" id="btnGuardar" class="btn-primary w-full h-11 rounded-md text-sm font-medium">
                    Guardar registro
                </button>
            </form>
        </section>

        <section id="section-history" class="app-section hidden pb-24">
            <header class="sticky top-0 z-10 bg-card border-b border-border px-4 py-3 flex justify-between items-center">
                <h2 class="text-base font-semibold text-card-foreground">Historial</h2>
                <button type="button" id="themeToggleHistory" class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema" aria-label="Cambiar tema">
                    <svg id="iconSunHistory" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="iconMoonHistory" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </header>
            <div class="p-4 space-y-4">
                <div id="historySummary" class="card p-4 grid grid-cols-2 sm:grid-cols-3 gap-3 hidden"></div>
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-card-foreground">Categoría:</span>
                        <select id="historyFilterCategory" class="input-base h-9 px-3 text-sm w-full max-w-[160px]" onchange="cargarHistorialConFiltro()"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-card-foreground">Usuario:</span>
                        <select id="historyFilterUsuario" class="input-base h-9 px-3 text-sm w-full max-w-[160px]" onchange="cargarHistorialConFiltro()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
                <div id="historyList" class="space-y-4"></div>
            </div>
        </section>

        <nav class="fixed bottom-0 left-0 right-0 bg-card border-t border-border flex justify-around py-3 z-50 max-w-lg mx-auto">
            <button type="button" onclick="switchTab('home')" id="nav-home" class="nav-btn active flex flex-col items-center gap-1 px-4 py-1 rounded-md hover:bg-muted/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                <span class="text-xs font-medium">Nuevo</span>
            </button>
            <button type="button" onclick="switchTab('history')" id="nav-history" class="nav-btn flex flex-col items-center gap-1 px-4 py-1 rounded-md hover:bg-muted/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs font-medium">Historial</span>
            </button>
            <button type="button" onclick="cerrarSesion()" class="nav-btn flex flex-col items-center gap-1 px-4 py-1 text-destructive hover:bg-destructive/10 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H4a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                <span class="text-xs font-medium">Salir</span>
            </button>
        </nav>
    </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbws4aCQAMPIY-QrLQIeEaJPilmGNtZ4GwN95mc9dmIovqSXCakh0mJiGfxrbUtWyakXDg/exec";
let tasaActual = 40;
let imgB64 = null;
let historyData = [];

function getTheme() {
    const stored = localStorage.getItem('theme');
    if (stored === 'dark' || stored === 'light') return stored;
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
    return 'light';
}

function setTheme(mode) {
    localStorage.setItem('theme', mode);
    document.documentElement.classList.toggle('dark', mode === 'dark');
    updateThemeIcons();
}

function toggleTheme() {
    setTheme(getTheme() === 'dark' ? 'light' : 'dark');
}

function updateThemeIcons() {
    const isDark = document.documentElement.classList.contains('dark');
    ['Login', 'Home', 'History'].forEach(suffix => {
        const sun = document.getElementById('iconSun' + (suffix === 'Login' ? '' : suffix));
        const moon = document.getElementById('iconMoon' + (suffix === 'Login' ? '' : suffix));
        if (sun) { sun.classList.toggle('hidden', !isDark); }
        if (moon) { moon.classList.toggle('hidden', isDark); }
    });
}

function showToast(message, type) {
    const toast = document.getElementById('toast');
    const content = document.getElementById('toastContent');
    content.innerHTML = type === 'success'
        ? `<span class="text-green-600">✓</span><span class="text-sm text-card-foreground">${message}</span>`
        : `<span class="text-destructive">✕</span><span class="text-sm text-card-foreground">${message}</span>`;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
}

window.onload = () => {
    setTheme(getTheme());
    const sesion = localStorage.getItem('session');
    if (sesion) {
        mostrarApp(JSON.parse(sesion).nombre);
        obtenerCategorias();
    }
    const ahora = new Date();
    ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
    document.getElementById('fecha').value = ahora.toISOString().slice(0, 16);
    obtenerTasa();
};

async function obtenerTasa() {
    try {
        const res = await fetch(`${WEB_APP_URL}?action=getTasa`);
        const data = await res.json();
        tasaActual = data.tasa;
        actualizarBadgeTasa();
    } catch (e) {
        actualizarBadgeTasa();
    }
}

function actualizarBadgeTasa() {
    const el = document.getElementById('tasaBadge');
    if (el) el.innerText = "Tasa: " + tasaActual + " Bs";
}

async function obtenerCategorias() {
    try {
        const res = await fetch(`${WEB_APP_URL}?action=getCategorias`);
        const data = await res.json();
        const cats = data.categorias || [];
        llenarSelectCategorias(cats);
    } catch (e) {
        llenarSelectCategorias(["Alimentos", "Servicios", "Transporte", "Varios"]);
    }
}

function llenarSelectCategorias(cats) {
    const opts = cats.map(c => `<option value="${(c || '').replace(/"/g, '&quot;')}">${(c || '').replace(/</g, '&lt;')}</option>`).join('');
    const selForm = document.getElementById('categoria');
    const selHist = document.getElementById('historyFilterCategory');
    if (selForm) selForm.innerHTML = opts;
    if (selHist) selHist.innerHTML = '<option value="">Todas</option>' + opts;
}

function abrirModalTasa() {
    document.getElementById('inputTasa').value = tasaActual;
    document.getElementById('modalTasa').classList.remove('hidden');
    document.getElementById('tasaBCVMsg').classList.add('hidden');
}

function cerrarModalTasa() {
    document.getElementById('modalTasa').classList.add('hidden');
}

async function guardarTasaManual() {
    const input = document.getElementById('inputTasa');
    const val = parseFloat(input.value);
    if (isNaN(val) || val <= 0) {
        showToast("Escribe una tasa válida.", "error");
        return;
    }
    const loader = document.getElementById('loader');
    loader.classList.add('active');
    try {
        const res = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'setTasa', tasa: val }) });
        const data = await res.json();
        if (data.status === 'success') {
            tasaActual = data.tasa;
            actualizarBadgeTasa();
            cerrarModalTasa();
            showToast("Tasa guardada.", "success");
        } else throw new Error(data.message || "Error");
    } catch (e) {
        showToast(e.message || "Error al guardar tasa", "error");
    }
    loader.classList.remove('active');
}

async function obtenerTasaBCV() {
    const msgEl = document.getElementById('tasaBCVMsg');
    msgEl.classList.remove('hidden');
    msgEl.textContent = "Consultando BCV...";
    try {
        const res = await fetch(`${WEB_APP_URL}?action=getTasaBCV`);
        const data = await res.json();
        if (data.status === 'success') {
            tasaActual = data.tasa;
            actualizarBadgeTasa();
            document.getElementById('inputTasa').value = tasaActual;
            msgEl.textContent = "Tasa BCV actualizada: " + tasaActual + " Bs";
        } else {
            msgEl.textContent = data.message || "No se pudo obtener la tasa.";
        }
    } catch (e) {
        msgEl.textContent = "Error de conexión.";
    }
}

function abrirModalNuevaCategoria() {
    document.getElementById('inputNuevaCategoria').value = '';
    document.getElementById('modalNuevaCategoria').classList.remove('hidden');
}

function cerrarModalNuevaCategoria() {
    document.getElementById('modalNuevaCategoria').classList.add('hidden');
}

async function agregarCategoria() {
    const input = document.getElementById('inputNuevaCategoria');
    const nombre = (input.value || '').trim();
    if (!nombre) {
        showToast("Escribe el nombre de la categoría.", "error");
        return;
    }
    const loader = document.getElementById('loader');
    loader.classList.add('active');
    try {
        const res = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'addCategoria', nombre: nombre }) });
        const data = await res.json();
        if (data.status === 'success') {
            llenarSelectCategorias(data.categorias || []);
            input.value = '';
            cerrarModalNuevaCategoria();
            showToast("Categoría agregada.", "success");
        } else throw new Error(data.message || "Error");
    } catch (e) {
        showToast(e.message || "Error al agregar", "error");
    }
    loader.classList.remove('active');
}

function calcularUsd() {
    const ves = document.getElementById('ves').value;
    document.getElementById('usd').value = (ves && tasaActual > 0) ? (ves / tasaActual).toFixed(2) : "";
}

function procesarImagen(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 800;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h *= MAX / w; w = MAX; } else if (h > MAX) { w *= MAX / h; h = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                imgB64 = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('preview').src = imgB64;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('fileName').innerText = "Imagen lista";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

async function validarAcceso() {
    const email = document.getElementById('userEmail').value.trim();
    const clave = document.getElementById('userPass').value;
    if (!email || !clave) {
        showToast("Completa correo y contraseña.", "error");
        return;
    }
    document.getElementById('loader').classList.add('active');
    document.getElementById('errorMsg').classList.add('hidden');
    try {
        const res = await fetch(`${WEB_APP_URL}?action=validarUsuario&email=${encodeURIComponent(email)}&clave=${encodeURIComponent(clave)}`);
        const data = await res.json();
        if (data.status === 'success') {
            localStorage.setItem('session', JSON.stringify(data));
            mostrarApp(data.nombre);
        } else {
            document.getElementById('errorMsg').classList.remove('hidden');
        }
    } catch (e) {
        showToast("Error de red. Revisa tu conexión.", "error");
    }
    document.getElementById('loader').classList.remove('active');
}

function mostrarApp(nombre) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('usuarioDisplay').value = nombre;
    obtenerCategorias();
}

document.getElementById('formGasto').onsubmit = async (e) => {
    e.preventDefault();
    const loader = document.getElementById('loader');
    loader.classList.add('active');

    const payload = {
        fecha: document.getElementById('fecha').value,
        usuario: document.getElementById('usuarioDisplay').value,
        usd: document.getElementById('usd').value,
        ves: document.getElementById('ves').value,
        categoria: document.getElementById('categoria').value,
        observacion: document.getElementById('observacion').value,
        archivoB64: imgB64
    };

    try {
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await res.json();

        if (data.status === "success") {
            const msg = data.imageWarning
                ? "Registro guardado. La imagen no pudo subirse."
                : "Registro guardado correctamente.";
            showToast(msg, data.imageWarning ? "error" : "success");
            imgB64 = null;
            setTimeout(() => location.reload(), 1500);
        } else {
            throw new Error(data.message || "Error en el servidor");
        }
    } catch (err) {
        showToast(err.message || "Error al guardar", "error");
    } finally {
        loader.classList.remove('active');
    }
};

function switchTab(t) {
    document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
    document.getElementById('section-' + t).classList.remove('hidden');
    document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('active');
        b.classList.add('nav-btn');
    });
    const activeBtn = document.getElementById('nav-' + t);
    if (activeBtn) activeBtn.classList.add('active');
    if (t === 'history') cargarHistorial();
}

function formatRelativeDate(d) {
    const date = new Date(d);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const timeStr = date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
    if (dateOnly.getTime() === today.getTime()) return 'Hoy · ' + timeStr;
    if (dateOnly.getTime() === yesterday.getTime()) return 'Ayer · ' + timeStr;
    return date.toLocaleDateString('es', { day: 'numeric', month: 'short', year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined }) + ' · ' + timeStr;
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    const filtered = getFilteredHistoryData();
    if (!filtered.length) {
        const noData = historyData.length === 0;
        const msg = noData ? 'No hay registros aún' : 'No hay gastos con los filtros seleccionados';
        const sub = noData ? 'Añade el primero desde Nuevo' : 'Prueba otra categoría o usuario';
        list.innerHTML = `
            <div class="text-center py-12">
                <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-muted text-muted-foreground mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                </div>
                <p class="text-sm font-medium text-card-foreground">${msg}</p>
                <p class="text-xs text-muted-foreground mt-1">${sub}</p>
            </div>`;
        return;
    }
    const byDate = {};
    filtered.forEach(g => {
        const d = new Date(g[1]);
        const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        if (!byDate[key]) byDate[key] = [];
        byDate[key].push(g);
    });
    const sortedKeys = Object.keys(byDate).sort((a, b) => b.localeCompare(a));
    const todayKey = new Date().toISOString().slice(0, 10);
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayKey = yesterday.toISOString().slice(0, 10);
    function groupLabel(key) {
        if (key === todayKey) return 'Hoy';
        if (key === yesterdayKey) return 'Ayer';
        const [y, m, d] = key.split('-');
        const months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
        return d + ' ' + months[parseInt(m, 10) - 1] + (y !== new Date().getFullYear().toString() ? ' ' + y : '');
    }
    list.innerHTML = sortedKeys.map(key => {
        const items = byDate[key];
        const rows = items.map(g => {
            const linkImg = g[5] && g[5].startsWith('http') ? g[5] : null;
            const usd = parseFloat(g[3] || 0);
            const ves = parseFloat(g[4] || 0);
            return `
                <div class="card p-4 flex items-center gap-4 hover:border-border/80 transition-colors">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-card-foreground truncate">${(g[7] || 'Sin observación').replace(/</g, '&lt;')}</p>
                        <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                            <span class="text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded font-medium">${(g[6] || '').replace(/</g, '&lt;')}</span>
                            <span class="text-xs text-muted-foreground">${formatRelativeDate(g[1])}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-right">
                            <p class="text-sm font-semibold text-card-foreground">$${usd.toFixed(2)}</p>
                            <p class="text-xs text-muted-foreground">${ves.toFixed(2)} Bs</p>
                        </div>
                        ${linkImg ? `
                            <a href="${linkImg}" target="_blank" rel="noopener" class="p-2 rounded-md border border-border text-muted-foreground hover:bg-muted hover:text-card-foreground transition-colors" title="Ver factura">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14" /></svg>
                            </a>
                        ` : `
                            <span class="p-2 rounded-md border border-border text-muted-foreground/50" title="Sin imagen"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14" /></svg></span>
                        `}
                    </div>
                </div>`;
        }).join('');
        return `<div class="space-y-2"><p class="history-group-title">${groupLabel(key)} — ${items.length} ${items.length === 1 ? 'gasto' : 'gastos'}</p>${rows}</div>`;
    }).join('');
}

function getFilteredHistoryData() {
    const filterCat = (document.getElementById('historyFilterCategory') || {}).value || '';
    const filterUser = (document.getElementById('historyFilterUsuario') || {}).value || '';
    return historyData.filter(g => {
        if (filterCat && (g[6] || '') !== filterCat) return false;
        if (filterUser && (g[2] || '') !== filterUser) return false;
        return true;
    });
}

function renderHistorySummary(data) {
    const summaryEl = document.getElementById('historySummary');
    if (!data || !data.length) { summaryEl.classList.add('hidden'); return; }
    const totalUsd = data.reduce((s, g) => s + parseFloat(g[3] || 0), 0);
    const totalVes = data.reduce((s, g) => s + parseFloat(g[4] || 0), 0);
    summaryEl.classList.remove('hidden');
    summaryEl.innerHTML = `
        <div class="space-y-0.5">
            <p class="text-xs text-muted-foreground font-medium">Total USD</p>
            <p class="text-lg font-semibold text-card-foreground">$${totalUsd.toFixed(2)}</p>
        </div>
        <div class="space-y-0.5">
            <p class="text-xs text-muted-foreground font-medium">Total Bs</p>
            <p class="text-lg font-semibold text-card-foreground">${totalVes.toFixed(2)}</p>
        </div>
        <div class="space-y-0.5 col-span-2 sm:col-span-1">
            <p class="text-xs text-muted-foreground font-medium">Registros</p>
            <p class="text-lg font-semibold text-card-foreground">${data.length}</p>
        </div>`;
}

function llenarFiltroUsuarios() {
    const set = new Set();
    historyData.forEach(g => { const u = (g[2] || '').toString().trim(); if (u) set.add(u); });
    const users = Array.from(set).sort();
    const sel = document.getElementById('historyFilterUsuario');
    if (!sel) return;
    const opts = '<option value="">Todos</option>' + users.map(u => `<option value="${(u || '').replace(/"/g, '&quot;')}">${(u || '').replace(/</g, '&lt;')}</option>`).join('');
    sel.innerHTML = opts;
}

function cargarHistorialConFiltro() {
    const filtered = getFilteredHistoryData();
    renderHistorySummary(filtered);
    renderHistoryList();
}

async function cargarHistorial() {
    const list = document.getElementById('historyList');
    const summaryEl = document.getElementById('historySummary');
    list.innerHTML = '<p class="text-center text-sm text-muted-foreground py-8">Cargando...</p>';
    summaryEl.classList.add('hidden');
    try {
        const res = await fetch(WEB_APP_URL);
        const data = await res.json();
        historyData = Array.isArray(data) ? data.reverse() : [];
        llenarFiltroUsuarios();
        const filtered = getFilteredHistoryData();
        renderHistorySummary(filtered);
        renderHistoryList();
    } catch (e) {
        list.innerHTML = '<p class="text-center text-sm text-destructive py-8">Error al cargar el historial.</p>';
    }
}

function cerrarSesion() {
    localStorage.clear();
    location.reload();
}
</script>
</body>
</html>
